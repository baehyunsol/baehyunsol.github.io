<!DOCTYPE html><html>

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width"/>
    
    <title>attattatt</title>
    
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding&amp;display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'"/>
    <!--<link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding&amp;display=swap" rel="stylesheet"/> -->
    
    <link href="page.css" rel="stylesheet"/><link href="markdown.css" rel="stylesheet"/><link href="nav.css" rel="stylesheet"/>
    
</head>

<body>




    <nav>
<p><a id="settingsopenbutton">&#9728;</a><a href="#top">&#9650;</a><a href="#bottom">&#9660;</a></p><div id="settingsmenubg"><div id="settingsmenu"><table><thead><tr><th colspan="2"><div class="align-right"> <span class="size-giant"><a id="settingsclosebutton">&#10006;</a></span></div></th></tr></thead><tbody><tr><td><div class="align-right">Theme:</div></td><td><div class="align-left"><a id="changethemebutton">Set Light Theme</a></div></td></tr><tr><td><div class="align-right">Horizontal Padding:</div></td><td><div class="align-left"><a id="growhorizontalbutton">Grow</a> <a id="shrinkhorizontalbutton">Shrink</a></div></td></tr><tr><td><div class="align-right">Font Size:</div></td><td><div class="align-left"><a id="growfontbutton">Grow</a> <a id="shrinkfontbutton">Shrink</a></div></td></tr><tr><td><div class="align-right">Settings:</div></td><td><div class="align-left"><a id="savesettingsbutton">Save All</a> <a id="discardsettingsbutton">Discard All</a></div></td></tr></tbody></table></div></div>
    </nav>


    <article class="markdown">
        <a id="top"></a>
<p>Tables: what to store?</p><p>only smart pointers on stack</p><ul><li>how does MIR know that?</li><li>stuffs on heap</li></ul><hr/><p>No tables: compare metadata directly (<code class="inline-code-span">before</code> vs <code class="inline-code-span">after</code>)</p><p>Assume: if a public API can modify metadata illegally, that&apos;s not my fault -&gt; blame the API</p><p>An illegal modification must either be unsafe Rust or written in another language</p><ul><li>Identify which metadata to check<ul><li>Illegal modification of metadata inside unsafe blocks<ul><li>How do I define <u>illegal</u>?<ul><li>pointer -&gt; int cast<ul><li>of a smart pointer</li></ul></li><li>transmute<ul><li>a smart pointer to a whatever type</li></ul></li><li>is that all? i dont think so...</li></ul></li><li>track the newly created value<ul><li>for transmuted ones, watch if someone tries to write on it</li><li>for integers, watch if it&apos;s casted back to a pointer</li></ul></li></ul></li><li>Calling foreign functions<ul><li>What should I check? Do I track all the smart pointers ever instantiated?</li></ul></li></ul></li></ul><hr/><p>Using hardware-aided protection</p><p>MPK</p><ul><li>you can attach a key to a page<ul><li>a key has to be allocated before attached</li><li>at most 16 keys can be allocated<ul><li>free one if there&apos;s no more room</li></ul></li><li>a key has 2-bits data<ul><li>one for read, the other for write</li></ul></li></ul></li><li>There&apos;s a 32-bit register in CPU (which can store 16 keys)<ul><li>called <code class="inline-code-span">PKRU</code></li></ul></li><li>a user-level instruction can change the value of a key<ul><li>read PKRU or write to PKRU</li></ul></li></ul><ul><li>set metadata read-only when entering an unsafe block<ul><li>how about modifying metadata legally?</li><li>what if the attacker modifies PKRU?</li></ul></li></ul><ul><li>put all the metadata inside a metadata-page<ul><li>the page is controlled by MPK</li><li>again, <code class="inline-code-span">struct Foo { vec: Vec&lt;u32&gt;, volatile: u32 }</code></li></ul></li></ul><hr/><p>Compiler stuffs</p><ul><li>rustc_parse::parse::item</li></ul><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-gray">///</span><span class="color-gray"> Parses the contents of a module (inner attributes followed by module items).</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code"><span class="color-violet">pub</span> <span class="color-violet">fn</span> <span class="color-aqua">parse_mod</span><span class="color-white">(</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code">    <span class="color-white">&amp;</span><span class="color-violet">mut</span> <span class="color-red">self</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">    <span class="color-red">term</span><span class="color-white">:</span> <span class="color-white">&amp;</span><span class="color-white">TokenKind,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code"><span class="color-white">)</span> <span class="color-white">-&gt;</span> <span class="color-white">PResult</span><span class="color-white">&lt;</span><span class="color-violet">&apos;a</span><span class="color-white">, </span><span class="color-white">(</span><span class="color-white">AttrVec, </span><span class="color-white">ThinVec</span><span class="color-white">&lt;</span><span class="color-white">P</span><span class="color-white">&lt;</span><span class="color-white">Item</span><span class="color-white">&gt;</span><span class="color-white">&gt;</span><span class="color-white">, ModSpans</span><span class="color-white">)</span><span class="color-white">&gt;</span> <span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">    <span class="color-violet">let</span><span class="color-white"> lo </span><span class="color-white">=</span> <span class="color-red">self</span><span class="color-white">.token.span</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">    <span class="color-violet">let</span><span class="color-white"> attrs </span><span class="color-white">=</span> <span class="color-red">self</span><span class="color-white">.</span><span class="color-emerald">parse_inner_attributes</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">?</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">    <span class="color-violet">let</span><span class="color-white"> post_attr_lo </span><span class="color-white">=</span> <span class="color-red">self</span><span class="color-white">.token.span</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">    <span class="color-violet">let</span> <span class="color-violet">mut</span><span class="color-white"> items </span><span class="color-white">=</span> <span class="color-white">ThinVec</span><span class="color-white">::</span><span class="color-white">new</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">;</span></span></span>
<span class="highlight code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code">    <span class="color-violet">while</span> <span class="color-violet">let</span> <span class="color-white">Some</span><span class="color-white">(</span><span class="color-violet">mut</span><span class="color-white"> item</span><span class="color-white">)</span> <span class="color-white">=</span> <span class="color-red">self</span><span class="color-white">.</span><span class="color-emerald">parse_item</span><span class="color-white">(</span><span class="color-white">ForceCollect</span><span class="color-white">::</span><span class="color-white">No</span><span class="color-white">)</span><span class="color-white">?</span> <span class="color-white">{</span></span></span>
<span class="highlight code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code"></span></span>
<span class="highlight code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code">        <span class="color-violet">if</span><span class="color-white"> item.kind.</span><span class="color-emerald">descr</span><span class="color-white">(</span><span class="color-white">)</span> <span class="color-white">=</span><span class="color-white">=</span> <span class="color-white">&quot;</span><span class="color-green">struct</span><span class="color-white">&quot;</span> <span class="color-white">{</span></span></span>
<span class="highlight code-fence-row"><span class="code-fence-index">14</span><span class="code-fence-code">            <span class="color-violet">for</span><span class="color-white"> attr </span><span class="color-white">in</span><span class="color-white"> item.attrs.</span><span class="color-emerald">iter</span><span class="color-white">(</span><span class="color-white">)</span> <span class="color-white">{</span></span></span>
<span class="highlight code-fence-row"><span class="code-fence-index">15</span><span class="code-fence-code">                <span class="color-violet">if</span><span class="color-white"> attr.</span><span class="color-emerald">name_or_empty</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">.</span><span class="color-emerald">as_str</span><span class="color-white">(</span><span class="color-white">)</span> <span class="color-white">=</span><span class="color-white">=</span> <span class="color-white">&quot;</span><span class="color-green">metadata</span><span class="color-white">&quot;</span> <span class="color-white">{</span></span></span>
<span class="highlight code-fence-row"><span class="code-fence-index">16</span><span class="code-fence-code">                    <span class="color-white">rustc_baehyunsol</span><span class="color-white">::</span><span class="color-white">push_node_id</span><span class="color-white">(</span><span class="color-white">item.id</span><span class="color-white">)</span><span class="color-white">;</span></span></span>
<span class="highlight code-fence-row"><span class="code-fence-index">17</span><span class="code-fence-code">                    <span class="color-violet">break</span><span class="color-white">;</span></span></span>
<span class="highlight code-fence-row"><span class="code-fence-index">18</span><span class="code-fence-code">                <span class="color-white">}</span></span></span>
<span class="highlight code-fence-row"><span class="code-fence-index">19</span><span class="code-fence-code">            <span class="color-white">}</span></span></span>
<span class="highlight code-fence-row"><span class="code-fence-index">20</span><span class="code-fence-code">        <span class="color-white">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">21</span><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-index">22</span><span class="code-fence-code"><span class="color-white">        items.</span><span class="color-emerald">push</span><span class="color-white">(</span><span class="color-white">item</span><span class="color-white">)</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">23</span><span class="code-fence-code">        <span class="color-red">self</span><span class="color-white">.</span><span class="color-emerald">maybe_consume_incorrect_semicolon</span><span class="color-white">(</span><span class="color-white">&amp;</span><span class="color-white">items</span><span class="color-white">)</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">24</span><span class="code-fence-code">    <span class="color-white">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">25</span><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-index">26</span><span class="code-fence-code">    <span class="color-violet">if</span> <span class="color-white">!</span><span class="color-red">self</span><span class="color-white">.</span><span class="color-emerald">eat</span><span class="color-white">(</span><span class="color-white">term</span><span class="color-white">)</span> <span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">27</span><span class="code-fence-code">        <span class="color-violet">let</span><span class="color-white"> token_str </span><span class="color-white">=</span> <span class="color-violet">super</span><span class="color-white">::</span><span class="color-white">token_descr</span><span class="color-white">(</span><span class="color-white">&amp;</span><span class="color-red">self</span><span class="color-white">.token</span><span class="color-white">)</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">28</span><span class="code-fence-code">        <span class="color-violet">if</span> <span class="color-white">!</span><span class="color-red">self</span><span class="color-white">.</span><span class="color-emerald">maybe_consume_incorrect_semicolon</span><span class="color-white">(</span><span class="color-white">&amp;</span><span class="color-white">items</span><span class="color-white">)</span> <span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">29</span><span class="code-fence-code">            <span class="color-violet">let</span><span class="color-white"> msg </span><span class="color-white">=</span> <span class="color-white">format!</span><span class="color-white">(</span><span class="color-white">&quot;</span><span class="color-green">expected item, found </span><span class="color-gold">{token_str}</span><span class="color-white">&quot;</span><span class="color-white">)</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">30</span><span class="code-fence-code">            <span class="color-violet">let</span> <span class="color-violet">mut</span><span class="color-white"> err </span><span class="color-white">=</span> <span class="color-red">self</span><span class="color-white">.</span><span class="color-emerald">struct_span_err</span><span class="color-white">(</span><span class="color-red">self</span><span class="color-white">.token.span</span><span class="color-white">,</span><span class="color-white"> msg</span><span class="color-white">)</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">31</span><span class="code-fence-code">            <span class="color-violet">let</span><span class="color-white"> label </span><span class="color-white">=</span> <span class="color-violet">if</span> <span class="color-red">self</span><span class="color-white">.</span><span class="color-emerald">is_kw_followed_by_ident</span><span class="color-white">(</span><span class="color-white">kw</span><span class="color-white">::</span><span class="color-white">Let</span><span class="color-white">)</span> <span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">32</span><span class="code-fence-code">                <span class="color-white">&quot;</span><span class="color-green">consider using `const` or `static` instead of `let` for global variables</span><span class="color-white">&quot;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">33</span><span class="code-fence-code">            <span class="color-white">}</span> <span class="color-violet">else</span> <span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">34</span><span class="code-fence-code">                <span class="color-white">&quot;</span><span class="color-green">expected item</span><span class="color-white">&quot;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">35</span><span class="code-fence-code">            <span class="color-white">}</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">36</span><span class="code-fence-code"><span class="color-white">            err.</span><span class="color-emerald">span_label</span><span class="color-white">(</span><span class="color-red">self</span><span class="color-white">.token.span</span><span class="color-white">,</span><span class="color-white"> label</span><span class="color-white">)</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">37</span><span class="code-fence-code">            <span class="color-violet">return</span> <span class="color-white">Err</span><span class="color-white">(</span><span class="color-white">err</span><span class="color-white">)</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">38</span><span class="code-fence-code">        <span class="color-white">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">39</span><span class="code-fence-code">    <span class="color-white">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">40</span><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-index">41</span><span class="code-fence-code">    <span class="color-violet">let</span><span class="color-white"> inject_use_span </span><span class="color-white">=</span><span class="color-white"> post_attr_lo.</span><span class="color-emerald">data</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">.</span><span class="color-emerald">with_hi</span><span class="color-white">(</span><span class="color-white">post_attr_lo.</span><span class="color-emerald">lo</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">)</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">42</span><span class="code-fence-code">    <span class="color-violet">let</span><span class="color-white"> mod_spans </span><span class="color-white">=</span><span class="color-white"> ModSpans </span><span class="color-white">{</span><span class="color-white"> inner_span</span><span class="color-white">:</span><span class="color-white"> lo.</span><span class="color-emerald">to</span><span class="color-white">(</span><span class="color-red">self</span><span class="color-white">.prev_token.span</span><span class="color-white">)</span><span class="color-white">,</span><span class="color-white"> inject_use_span </span><span class="color-white">}</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">43</span><span class="code-fence-code">    <span class="color-white">Ok</span><span class="color-white">(</span><span class="color-white">(</span><span class="color-white">attrs</span><span class="color-white">,</span><span class="color-white"> items</span><span class="color-white">,</span><span class="color-white"> mod_spans</span><span class="color-white">)</span><span class="color-white">)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">44</span><span class="code-fence-code"><span class="color-white">}</span></span></span>
</code><button onclick="copy_code_to_clipboard(0)" class="copy-fenced-code">Copy</button></pre><ul><li>lowering HIR to MIR</li></ul><pre class="fenced-code-block line-num-width-1"><code><span class="code-fence-row"><span class="code-fence-index">1</span><span class="code-fence-code"><span class="color-violet">fn</span> <span class="color-aqua">adt_def</span><span class="color-white">(</span><span class="color-red">tcx</span><span class="color-white">:</span> <span class="color-white">TyCtxt</span><span class="color-white">&lt;</span><span class="color-white">&apos;</span><span class="color-white">_</span><span class="color-white">&gt;</span><span class="color-white">, </span><span class="color-red">def_id</span><span class="color-white">:</span><span class="color-white"> LocalDefId</span><span class="color-white">)</span> <span class="color-white">-&gt;</span> <span class="color-white">ty</span><span class="color-white">::</span><span class="color-white">AdtDef</span><span class="color-white">&lt;</span><span class="color-white">&apos;</span><span class="color-white">_</span><span class="color-white">&gt;</span> <span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">2</span><span class="code-fence-code">    <span class="color-violet">use</span> <span class="color-white">rustc_hir</span><span class="color-white">::</span><span class="color-white">*</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">3</span><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-index">4</span><span class="code-fence-code">    <span class="color-violet">let</span><span class="color-white"> hir_id </span><span class="color-white">=</span><span class="color-white"> tcx.</span><span class="color-emerald">hir</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">.</span><span class="color-emerald">local_def_id_to_hir_id</span><span class="color-white">(</span><span class="color-white">def_id</span><span class="color-white">)</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">5</span><span class="code-fence-code">    <span class="color-violet">let</span> <span class="color-white">Node</span><span class="color-white">::</span><span class="color-white">Item</span><span class="color-white">(</span><span class="color-white">item</span><span class="color-white">)</span> <span class="color-white">=</span><span class="color-white"> tcx.</span><span class="color-emerald">hir</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">.</span><span class="color-emerald">get</span><span class="color-white">(</span><span class="color-white">hir_id</span><span class="color-white">)</span> <span class="color-violet">else</span> <span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">6</span><span class="code-fence-code">        <span class="color-white">bug!</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">7</span><span class="code-fence-code">    <span class="color-white">}</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">8</span><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-index">9</span><span class="code-fence-code">    <span class="color-violet">let</span><span class="color-white"> repr </span><span class="color-white">=</span><span class="color-white"> tcx.</span><span class="color-emerald">repr_options_of_def</span><span class="color-white">(</span><span class="color-white">def_id.</span><span class="color-emerald">to_def_id</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">)</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">10</span><span class="code-fence-code">    <span class="color-violet">let</span> <span class="color-white">(</span><span class="color-white">kind</span><span class="color-white">,</span><span class="color-white"> variants</span><span class="color-white">)</span> <span class="color-white">=</span> <span class="color-violet">match</span> <span class="color-white">&amp;</span><span class="color-white">item.kind </span><span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">11</span><span class="code-fence-code">        <span class="color-white">ItemKind</span><span class="color-white">::</span><span class="color-white">Enum</span><span class="color-white">(</span><span class="color-white">def</span><span class="color-white">,</span> <span class="color-white">_</span><span class="color-white">)</span> <span class="color-white">=&gt;</span> <span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">12</span><span class="code-fence-code">            <span class="color-violet">let</span> <span class="color-violet">mut</span><span class="color-white"> distance_from_explicit </span><span class="color-white">=</span> <span class="color-gold">0</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">13</span><span class="code-fence-code">            <span class="color-violet">let</span><span class="color-white"> variants </span><span class="color-white">=</span><span class="color-white"> def</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">14</span><span class="code-fence-code"><span class="color-white">                .variants</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">15</span><span class="code-fence-code"><span class="color-white">                .</span><span class="color-emerald">iter</span><span class="color-white">(</span><span class="color-white">)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">16</span><span class="code-fence-code"><span class="color-white">                .</span><span class="color-emerald">map</span><span class="color-white">(</span><span class="color-white">|</span><span class="color-red">v</span><span class="color-white">|</span> <span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">17</span><span class="code-fence-code">                    <span class="color-violet">let</span><span class="color-white"> discr </span><span class="color-white">=</span> <span class="color-violet">if</span> <span class="color-violet">let</span> <span class="color-white">Some</span><span class="color-white">(</span><span class="color-white">e</span><span class="color-white">)</span> <span class="color-white">=</span> <span class="color-white">&amp;</span><span class="color-white">v.disr_expr </span><span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">18</span><span class="code-fence-code"><span class="color-white">                        distance_from_explicit </span><span class="color-white">=</span> <span class="color-gold">0</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">19</span><span class="code-fence-code">                        <span class="color-white">ty</span><span class="color-white">::</span><span class="color-white">VariantDiscr</span><span class="color-white">::</span><span class="color-white">Explicit</span><span class="color-white">(</span><span class="color-white">e.def_id.</span><span class="color-emerald">to_def_id</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">20</span><span class="code-fence-code">                    <span class="color-white">}</span> <span class="color-violet">else</span> <span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">21</span><span class="code-fence-code">                        <span class="color-white">ty</span><span class="color-white">::</span><span class="color-white">VariantDiscr</span><span class="color-white">::</span><span class="color-white">Relative</span><span class="color-white">(</span><span class="color-white">distance_from_explicit</span><span class="color-white">)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">22</span><span class="code-fence-code">                    <span class="color-white">}</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">23</span><span class="code-fence-code"><span class="color-white">                    distance_from_explicit </span><span class="color-white">+</span><span class="color-white">=</span> <span class="color-gold">1</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">24</span><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-index">25</span><span class="code-fence-code">                    <span class="color-emerald">convert_variant</span><span class="color-white">(</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">26</span><span class="code-fence-code"><span class="color-white">                        tcx</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">27</span><span class="code-fence-code">                        <span class="color-white">Some</span><span class="color-white">(</span><span class="color-white">v.def_id</span><span class="color-white">)</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">28</span><span class="code-fence-code"><span class="color-white">                        v.ident</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">29</span><span class="code-fence-code"><span class="color-white">                        discr</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">30</span><span class="code-fence-code">                        <span class="color-white">&amp;</span><span class="color-white">v.data</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">31</span><span class="code-fence-code">                        <span class="color-white">AdtKind</span><span class="color-white">::</span><span class="color-white">Enum</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">32</span><span class="code-fence-code"><span class="color-white">                        def_id</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">33</span><span class="code-fence-code">                    <span class="color-white">)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">34</span><span class="code-fence-code">                <span class="color-white">}</span><span class="color-white">)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">35</span><span class="code-fence-code"><span class="color-white">                .</span><span class="color-emerald">collect</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">36</span><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-index">37</span><span class="code-fence-code">            <span class="color-white">(</span><span class="color-white">AdtKind</span><span class="color-white">::</span><span class="color-white">Enum</span><span class="color-white">,</span><span class="color-white"> variants</span><span class="color-white">)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">38</span><span class="code-fence-code">        <span class="color-white">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">39</span><span class="code-fence-code">        <span class="color-white">ItemKind</span><span class="color-white">::</span><span class="color-white">Struct</span><span class="color-white">(</span><span class="color-white">def</span><span class="color-white">,</span> <span class="color-white">_</span><span class="color-white">)</span> <span class="color-white">|</span> <span class="color-white">ItemKind</span><span class="color-white">::</span><span class="color-white">Union</span><span class="color-white">(</span><span class="color-white">def</span><span class="color-white">,</span> <span class="color-white">_</span><span class="color-white">)</span> <span class="color-white">=&gt;</span> <span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">40</span><span class="code-fence-code">            <span class="color-violet">let</span><span class="color-white"> adt_kind </span><span class="color-white">=</span> <span class="color-violet">match</span><span class="color-white"> item.kind </span><span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">41</span><span class="code-fence-code">                <span class="color-white">ItemKind</span><span class="color-white">::</span><span class="color-white">Struct</span><span class="color-white">(</span><span class="color-white">..</span><span class="color-white">)</span> <span class="color-white">=&gt;</span> <span class="color-white">AdtKind</span><span class="color-white">::</span><span class="color-white">Struct</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">42</span><span class="code-fence-code">                <span class="color-white">_</span> <span class="color-white">=&gt;</span> <span class="color-white">AdtKind</span><span class="color-white">::</span><span class="color-white">Union</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">43</span><span class="code-fence-code">            <span class="color-white">}</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">44</span><span class="code-fence-code"></span></span>
<span class="highlight code-fence-row"><span class="code-fence-index">45</span><span class="code-fence-code">            <span class="color-gray">//</span><span class="color-gray"> TODO: not working</span></span></span>
<span class="highlight code-fence-row"><span class="code-fence-index">46</span><span class="code-fence-code">            <span class="color-violet">if</span> <span class="color-white">rustc_baehyunsol</span><span class="color-white">::</span><span class="color-white">is_smart_pointer_node_id</span><span class="color-white">(</span><span class="color-white">item.id</span><span class="color-white">)</span> <span class="color-white">{</span> <span class="color-white">rustc_baehyunsol</span><span class="color-white">::</span><span class="color-white">push_def_id</span><span class="color-white">(</span><span class="color-white">def_id.</span><span class="color-emerald">to_def_id</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">)</span><span class="color-white">;</span> <span class="color-white">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">47</span><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-index">48</span><span class="code-fence-code">            <span class="color-violet">let</span><span class="color-white"> variants </span><span class="color-white">=</span> <span class="color-white">std</span><span class="color-white">::</span><span class="color-white">iter</span><span class="color-white">::</span><span class="color-white">once</span><span class="color-white">(</span><span class="color-emerald">convert_variant</span><span class="color-white">(</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">49</span><span class="code-fence-code"><span class="color-white">                tcx</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">50</span><span class="code-fence-code">                <span class="color-white">None</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">51</span><span class="code-fence-code"><span class="color-white">                item.ident</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">52</span><span class="code-fence-code">                <span class="color-white">ty</span><span class="color-white">::</span><span class="color-white">VariantDiscr</span><span class="color-white">::</span><span class="color-white">Relative</span><span class="color-white">(</span><span class="color-gold">0</span><span class="color-white">)</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">53</span><span class="code-fence-code"><span class="color-white">                def</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">54</span><span class="code-fence-code"><span class="color-white">                adt_kind</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">55</span><span class="code-fence-code"><span class="color-white">                def_id</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">56</span><span class="code-fence-code">            <span class="color-white">)</span><span class="color-white">)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">57</span><span class="code-fence-code"><span class="color-white">            .</span><span class="color-emerald">collect</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">58</span><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-index">59</span><span class="code-fence-code">            <span class="color-white">(</span><span class="color-white">adt_kind</span><span class="color-white">,</span><span class="color-white"> variants</span><span class="color-white">)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">60</span><span class="code-fence-code">        <span class="color-white">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">61</span><span class="code-fence-code">        <span class="color-white">_</span> <span class="color-white">=&gt;</span> <span class="color-white">bug!</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">,</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">62</span><span class="code-fence-code">    <span class="color-white">}</span><span class="color-white">;</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">63</span><span class="code-fence-code"><span class="color-white">    tcx.</span><span class="color-emerald">mk_adt_def</span><span class="color-white">(</span><span class="color-white">def_id.</span><span class="color-emerald">to_def_id</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">,</span><span class="color-white"> kind</span><span class="color-white">,</span><span class="color-white"> variants</span><span class="color-white">,</span><span class="color-white"> repr</span><span class="color-white">)</span></span></span>
<span class="code-fence-row"><span class="code-fence-index">64</span><span class="code-fence-code"><span class="color-white">}</span></span></span>
</code><button onclick="copy_code_to_clipboard(1)" class="copy-fenced-code">Copy</button></pre><ul><li>analysis at MIR</li></ul><pre class="fenced-code-block"><code><span class="code-fence-row"><span class="code-fence-code"><span class="color-violet">fn</span> <span class="color-aqua">warn_smart_pointer</span><span class="color-white">&lt;</span><span class="color-violet">&apos;tcx</span><span class="color-white">&gt;</span><span class="color-white">(</span><span class="color-red">place</span><span class="color-white">:</span> <span class="color-white">&amp;</span><span class="color-white">Place</span><span class="color-white">&lt;</span><span class="color-violet">&apos;tcx</span><span class="color-white">&gt;</span><span class="color-white">, </span><span class="color-red">local_decls</span><span class="color-white">:</span> <span class="color-white">&amp;</span><span class="color-white">IndexVec</span><span class="color-white">&lt;</span><span class="color-white">mir</span><span class="color-white">::</span><span class="color-white">Local, </span><span class="color-white">mir</span><span class="color-white">::</span><span class="color-white">LocalDecl</span><span class="color-white">&lt;</span><span class="color-violet">&apos;tcx</span><span class="color-white">&gt;</span><span class="color-white">&gt;</span><span class="color-white">)</span> <span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-code">    <span class="color-violet">if</span> <span class="color-violet">let</span> <span class="color-white">Some</span><span class="color-white">(</span><span class="color-white">local_decl</span><span class="color-white">)</span> <span class="color-white">=</span><span class="color-white"> local_decls.</span><span class="color-emerald">get</span><span class="color-white">(</span><span class="color-white">place.local</span><span class="color-white">)</span> <span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-code">        <span class="color-violet">if</span> <span class="color-violet">let</span> <span class="color-white">Some</span><span class="color-white">(</span><span class="color-white">adt_def</span><span class="color-white">)</span> <span class="color-white">=</span><span class="color-white"> local_decl.ty.</span><span class="color-emerald">peel_refs</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">.</span><span class="color-emerald">ty_adt_def</span><span class="color-white">(</span><span class="color-white">)</span> <span class="color-white">{</span></span></span>
<span class="code-fence-row"><span class="code-fence-code">            <span class="color-violet">if</span> <span class="color-white">rustc_baehyunsol</span><span class="color-white">::</span><span class="color-white">is_smart_pointer_def_id</span><span class="color-white">(</span><span class="color-white">adt_def.</span><span class="color-emerald">did</span><span class="color-white">(</span><span class="color-white">)</span><span class="color-white">)</span> <span class="color-white">{</span> <span class="color-gray">/*</span><span class="color-gray"> Do Something </span><span class="color-gray">*/</span> <span class="color-white">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-code">        <span class="color-white">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-code">    <span class="color-white">}</span></span></span>
<span class="code-fence-row"><span class="code-fence-code"><span class="color-white">}</span></span></span>
</code></pre><script>/*<![CDATA[*/
const fenced_code_block_contents = ["/// Parses the contents of a module (inner attributes followed by module items).\npub fn parse_mod(\n    &mut self,\n    term: &TokenKind,\n) -> PResult<'a, (AttrVec, ThinVec<P<Item>>, ModSpans)> {\n    let lo = self.token.span;\n    let attrs = self.parse_inner_attributes()?;\n\n    let post_attr_lo = self.token.span;\n    let mut items = ThinVec::new();\n    while let Some(mut item) = self.parse_item(ForceCollect::No)? {\n\n        if item.kind.descr() == \"struct\" {\n            for attr in item.attrs.iter() {\n                if attr.name_or_empty().as_str() == \"metadata\" {\n                    rustc_baehyunsol::push_node_id(item.id);\n                    break;\n                }\n            }\n        }\n\n        items.push(item);\n        self.maybe_consume_incorrect_semicolon(&items);\n    }\n\n    if !self.eat(term) {\n        let token_str = super::token_descr(&self.token);\n        if !self.maybe_consume_incorrect_semicolon(&items) {\n            let msg = format!(\"expected item, found {token_str}\");\n            let mut err = self.struct_span_err(self.token.span, msg);\n            let label = if self.is_kw_followed_by_ident(kw::Let) {\n                \"consider using `const` or `static` instead of `let` for global variables\"\n            } else {\n                \"expected item\"\n            };\n            err.span_label(self.token.span, label);\n            return Err(err);\n        }\n    }\n\n    let inject_use_span = post_attr_lo.data().with_hi(post_attr_lo.lo());\n    let mod_spans = ModSpans { inner_span: lo.to(self.prev_token.span), inject_use_span };\n    Ok((attrs, items, mod_spans))\n}", "fn adt_def(tcx: TyCtxt<'_>, def_id: LocalDefId) -> ty::AdtDef<'_> {\n    use rustc_hir::*;\n\n    let hir_id = tcx.hir().local_def_id_to_hir_id(def_id);\n    let Node::Item(item) = tcx.hir().get(hir_id) else {\n        bug!();\n    };\n\n    let repr = tcx.repr_options_of_def(def_id.to_def_id());\n    let (kind, variants) = match &item.kind {\n        ItemKind::Enum(def, _) => {\n            let mut distance_from_explicit = 0;\n            let variants = def\n                .variants\n                .iter()\n                .map(|v| {\n                    let discr = if let Some(e) = &v.disr_expr {\n                        distance_from_explicit = 0;\n                        ty::VariantDiscr::Explicit(e.def_id.to_def_id())\n                    } else {\n                        ty::VariantDiscr::Relative(distance_from_explicit)\n                    };\n                    distance_from_explicit += 1;\n\n                    convert_variant(\n                        tcx,\n                        Some(v.def_id),\n                        v.ident,\n                        discr,\n                        &v.data,\n                        AdtKind::Enum,\n                        def_id,\n                    )\n                })\n                .collect();\n\n            (AdtKind::Enum, variants)\n        }\n        ItemKind::Struct(def, _) | ItemKind::Union(def, _) => {\n            let adt_kind = match item.kind {\n                ItemKind::Struct(..) => AdtKind::Struct,\n                _ => AdtKind::Union,\n            };\n\n            // TODO: not working\n            if rustc_baehyunsol::is_smart_pointer_node_id(item.id) { rustc_baehyunsol::push_def_id(def_id.to_def_id()); }\n\n            let variants = std::iter::once(convert_variant(\n                tcx,\n                None,\n                item.ident,\n                ty::VariantDiscr::Relative(0),\n                def,\n                adt_kind,\n                def_id,\n            ))\n            .collect();\n\n            (adt_kind, variants)\n        }\n        _ => bug!(),\n    };\n    tcx.mk_adt_def(def_id.to_def_id(), kind, variants, repr)\n}"];

function copy_code_to_clipboard(index) {
    navigator.clipboard.writeText(fenced_code_block_contents[index]);
}/*]]>*/</script>
        <a id="bottom"></a>
    </article>





    <script src="colors.js"></script>

    
    <script src="nav.js"></script>
    
    
    
</body>

</html>
