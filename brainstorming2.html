<!DOCTYPE html><html>

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width"/>
    
    <title>brainstorming2</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding&amp;display=swap" rel="stylesheet"/> 
    
    <link href="page.css" rel="stylesheet"/><link href="markdown.css" rel="stylesheet"/><link href="nav.css" rel="stylesheet"/>
    
</head>

<body>




    <nav>
<p><a id="settingsopenbutton">&#9728;</a><a href="#top">&#9650;</a><a href="#bottom">&#9660;</a></p><div id="settingsmenubg"><p><div id="settingsmenu"> <a id="settingsclosebutton">&#10006;</a> <a id="changethemebutton">Set Light Theme</a> <a id="loosepaddingbutton">&#8592; &#8594;</a> <a id="tightpaddingbutton">&#8594; &#8592;</a> </div></p></div>
    </nav>


    <article class="markdown">
        <a id="top"></a>
<p><div class="toc"><ol type="1"><li><a href="#conv_module">conv_module</a><ol type="1"><li><a href="#structure">structure</a></li><li><a href="#ports-and-nets">ports and nets</a><ol type="1"><li><a href="#s_axis_tready">S_AXIS_TREADY</a></li><li><a href="#s_axis_tdata">S_AXIS_TDATA</a></li><li><a href="#s_axis_tkeep">S_AXIS_TKEEP</a></li><li><a href="#s_axis_tuser">S_AXIS_TUSER</a></li><li><a href="#s_axis_tlast">S_AXIS_TLAST</a></li><li><a href="#s_axis_tvalid">S_AXIS_TVALID</a></li><li><a href="#m_axis_tready">M_AXIS_TREADY</a></li><li><a href="#m_axis_tdata">M_AXIS_TDATA</a></li><li><a href="#ofm">OFM</a></li><li><a href="#ofm_bias_valid">OFM_BIAS_VALID</a></li><li><a href="#feature_map_bias">feature_map_bias</a></li><li><a href="#bias_tmp">bias_tmp</a></li><li><a href="#bias_bram_dout">bias_bram_dout</a></li><li><a href="#prd_filter_cnt">prd_filter_cnt</a></li><li><a href="#receive_buf">receive_buf</a></li><li><a href="#axis_m_idle">AXIS_M_IDLE</a></li><li><a href="#receive_state">RECEIVE_STATE</a></li><li><a href="#command">command</a></li><li><a href="#data_received">data_received</a></li><li><a href="#conv_done">conv_done</a></li></ol></li></ol></li></ol></div></p><h1 id="conv_module">conv_module</h1><h2 id="structure">structure</h2><p>주석 그대로 갖고옴. 아래 보셈</p><pre class="fenced-code-block"><code><span class="code-fence-row"><span class="code-fence-code">  command = 1</span></span>
<span class="code-fence-row"><span class="code-fence-code">    get S_AXIS_TDATA and save it to feature DRAM</span></span>
<span class="code-fence-row"><span class="code-fence-code">    set feature_read_done signal after writing DRAM</span></span>
<span class="code-fence-row"><span class="code-fence-code">  command = 2</span></span>
<span class="code-fence-row"><span class="code-fence-code">    get S_AXIS_TDATA and save it to bias DRAM</span></span>
<span class="code-fence-row"><span class="code-fence-code">    set feature_read_done signal after writing DRAM</span></span>
<span class="code-fence-row"><span class="code-fence-code">  command = 3</span></span>
<span class="code-fence-row"><span class="code-fence-code">    get S_AXIS_TDATA and save it to weight DRAM</span></span>
<span class="code-fence-row"><span class="code-fence-code">    set feature_read_done signal after writing DRAM</span></span>
<span class="code-fence-row"><span class="code-fence-code">    read weight, bias , feature</span></span>
<span class="code-fence-row"><span class="code-fence-code">    calculate conv result</span></span>
<span class="code-fence-row"><span class="code-fence-code">      make MAC</span></span>
<span class="code-fence-row"><span class="code-fence-code">      compute MAC SIZE</span></span>
<span class="code-fence-row"><span class="code-fence-code">      determine # of MAC</span></span>
<span class="code-fence-row"><span class="code-fence-code">    RELU</span></span>
<span class="code-fence-row"><span class="code-fence-code">    send it to M_AXIS_TDATA</span></span>
<span class="code-fence-row"><span class="code-fence-code">    set conv_done signal after writing DRAM</span></span>
</code></pre><ul><li>FSM은 <a href="#command">command</a>라는 input이 제어함</li><li>각 command마다 <a href="#s_axis_tdata">S_AXIS_TDATA</a>한테 값을 받아서 DRAM에 넣는 거는 모두 동일</li><li>상세 구현은 달라도 큰 그림은 비슷할 듯? (TB든 Py든)<ol type="1"><li><a href="#s_axis_tdata">S_AXIS_TDATA</a>로 feature, bias, weight 순서로 받음</li><li>받아서 DRAM에 저장</li><li>DRAM에서 값 읽어서 conv 계산</li><li><a href="#m_axis_tdata">M_AXIS_TDATA</a>로 계산 결과 전송</li><li><a href="#conv_done">conv_done</a> 띄움</li></ol></li></ul><h2 id="ports-and-nets">ports and nets</h2><h3 id="s_axis_tready">S_AXIS_TREADY</h3><ul><li>output [1]</li><li><a href="#receive_state">RECEIVE_STATE</a>가 IDLE일 때는 0</li><li><a href="#receive_state">RECEIVE_STATE</a>가 IDLE이 아니고 아직 last data를 받기 전이면 1</li><li>얘가 1이고 <a href="#s_axis_tvalid">S_AXIS_TVALID</a>도 1이면 <a href="#receive_buf">receive_buf</a>에 <a href="#s_axis_tdata">S_AXIS_TDATA</a>를 씀</li></ul><h3 id="s_axis_tdata">S_AXIS_TDATA</h3><ul><li>input [32]</li><li>여기서 받은 정보를 곧바로 <a href="#receive_buf">receive_buf</a>에 넣음</li></ul><h3 id="s_axis_tkeep">S_AXIS_TKEEP</h3><ul><li>input [4]</li><li>not used</li></ul><h3 id="s_axis_tuser">S_AXIS_TUSER</h3><ul><li>input [1]</li><li>not used</li></ul><h3 id="s_axis_tlast">S_AXIS_TLAST</h3><ul><li>input [1]</li><li>last data인지 아닌지 판별하는 reg가 몇개 있는데 이걸로 관리함</li></ul><h3 id="s_axis_tvalid">S_AXIS_TVALID</h3><ul><li>input [1]</li><li>얘가 1이어야지만 <a href="#s_axis_tdata">S_AXIS_TDATA</a>가 valid함. 그래서 <a href="#s_axis_tdata">S_AXIS_TDATA</a> 받을 때 if로 검사하는게 전부</li></ul><h3 id="m_axis_tready">M_AXIS_TREADY</h3><ul><li>input [1]</li><li>얘가 1이고 <a href="#axis_m_idle">AXIS_M_IDLE</a>이 0이면 <a href="#m_axis_tdata">M_AXIS_TDATA</a>에 값을 씀. 당연히 [M_AXIS_TVALID]와 [M_AXIS_TLAST]도 수정</li></ul><h3 id="m_axis_tdata">M_AXIS_TDATA</h3><ul><li>output [32]</li><li>전송 중이 아닐 땐 항상 0. <a href="#m_axis_tready">M_AXIS_TREADY</a>가 1이고 <a href="#axis_m_idle">AXIS_M_IDLE</a>이 0이면 값을 씀</li><li><a href="#ofm">OFM</a>의 값을 이상한 logic에 통과시켜서 넣거든? 저게 뭔지는 더 봐야할 듯</li><li><a href="#m_axis_tdata">M_AXIS_TDATA</a>에 값 쓰는 부분에 주석으로 <code class="inline-code-span">relu</code>라고 돼 있음... 이게 어떻게 relu..??</li></ul><pre class="fenced-code-block"><code><span class="code-fence-row"><span class="code-fence-code">m_axis_tdata[7:0] &lt;= (OFM[send_row][send_col][31] ? 0 : (({18{OFM[send_row][send_col][31]}} == OFM[send_row][send_col][30:13]) ? {OFM[send_row][send_col][31], OFM[send_row][send_col][12:6]} :{OFM[send_row][send_col][31], {7{!OFM[send_row][send_col][31]}}}));</span></span>
<span class="code-fence-row"><span class="code-fence-code">m_axis_tdata[15:8] &lt;= (OFM[send_row][send_col+1][31] ? 0 : (({18{OFM[send_row][send_col+1][31]}} == OFM[send_row][send_col+1][30:13]) ?  {OFM[send_row][send_col+1][31], OFM[send_row][send_col+1][12:6]}:{OFM[send_row][send_col+1][31], {7{!OFM[send_row][send_col+1][31]}}}));</span></span>
<span class="code-fence-row"><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-code">if(send_col==width-2)begin</span></span>
<span class="code-fence-row"><span class="code-fence-code">  m_axis_tdata[23:16] &lt;= (OFM[send_row+1][0][31] ? 0 : (({18{OFM[send_row+1][0][31]}} == OFM[send_row+1][0][30:13]) ? {OFM[send_row+1][0][31], OFM[send_row+1][0][12:6]}:{OFM[send_row+1][0][31], {7{!OFM[send_row+1][0][31]}}}));</span></span>
<span class="code-fence-row"><span class="code-fence-code">  m_axis_tdata[31:24] &lt;= (OFM[send_row+1][1][31] ? 0 : (({18{OFM[send_row+1][1][31]}} == OFM[send_row+1][1][30:13]) ? {OFM[send_row+1][1][31], OFM[send_row+1][1][12:6]}:{OFM[send_row+1][1][31], {7{!OFM[send_row+1][1][31]}}}));</span></span>
<span class="code-fence-row"><span class="code-fence-code">end</span></span>
<span class="code-fence-row"><span class="code-fence-code"></span></span>
<span class="code-fence-row"><span class="code-fence-code">else begin</span></span>
<span class="code-fence-row"><span class="code-fence-code">  m_axis_tdata[23:16] &lt;= (OFM[send_row][send_col+2][31] ? 0 : (({18{OFM[send_row][send_col+2][31]}} == OFM[send_row][send_col+2][30:13]) ? {OFM[send_row][send_col+2][31], OFM[send_row][send_col+2][12:6]}:{OFM[send_row][send_col+2][31], {7{!OFM[send_row][send_col+2][31]}}}));</span></span>
<span class="code-fence-row"><span class="code-fence-code">  m_axis_tdata[31:24] &lt;= (OFM[send_row][send_col+3][31] ? 0 : (({18{OFM[send_row][send_col+3][31]}} == OFM[send_row][send_col+3][30:13]) ? {OFM[send_row][send_col+3][31], OFM[send_row][send_col+3][12:6]}:{OFM[send_row][send_col+3][31], {7{!OFM[send_row][send_col+3][31]}}}));</span></span>
<span class="code-fence-row"><span class="code-fence-code">end</span></span>
</code></pre><h3 id="ofm">OFM</h3><ul><li>reg signed [32][32][32]</li><li>32 bit짜리 data가 32 * 32 2차원 배열에 들어있음</li><li><a href="#ofm_bias_valid">OFM_BIAS_VALID</a>가 1이면 각 cell마다 <a href="#feature_map_bias">feature_map_bias</a>가 들어감</li></ul><h3 id="ofm_bias_valid">OFM_BIAS_VALID</h3><ul><li>reg [1]</li><li>항상 0이고 ~일 때만 1임</li></ul><h3 id="feature_map_bias">feature_map_bias</h3><ul><li>wire signed [32]</li><li><code class="inline-code-span">feature_map_bias = {{19{bias_tmp[7]}}, bias_tmp[6:0], 6&apos;b0};</code></li><li><a href="#bias_tmp">bias_tmp</a>를 sign extension한 값이 항상 들어감</li></ul><h3 id="bias_tmp">bias_tmp</h3><ul><li>wire signed [8]</li><li><code class="inline-code-span">bias_bram_dout[prd_filter_cnt*8+7-:8]</code></li><li><a href="#bias_bram_dout">bias_bram_dout</a>, <a href="#prd_filter_cnt">prd_filter_cnt</a> 참고</li></ul><h3 id="bias_bram_dout">bias_bram_dout</h3><ul><li>wire [32]</li><li>말그대로 bias_bram에 꽂혀있음!</li></ul><h3 id="prd_filter_cnt">prd_filter_cnt</h3><ul><li>reg [3]</li><li>주석으로는 <u>indicates which filter we are working with</u>라고 돼 있음</li></ul><h3 id="receive_buf">receive_buf</h3><ul><li>reg [32]</li><li><a href="#data_received">data_received</a>가 1이면 weight_bram_din이나 bias_bram_din, feature_bram_din에 receive_buf를 그대로 넣음</li></ul><h3 id="axis_m_idle">AXIS_M_IDLE</h3><ul><li>reg [1]</li><li><a href="#receive_state">RECEIVE_STATE</a>가 IDLE이거나 send가 끝났으면 1임</li></ul><h3 id="receive_state">RECEIVE_STATE</h3><ul><li>reg [3]</li><li><a href="#command">command</a>의 값을 그대로 받음</li><li>IDLE, FEATURE, BIAS, WEIGHT</li></ul><h3 id="command">command</h3><ul><li>input [3]</li><li>그대로 <a href="#receive_state">RECEIVE_STATE</a>에 대입</li><li>밖으로 conv_apb와 연결돼 있음<ul><li>conv_apb는 ABP를 통해 Python한테서 command를 받는 듯?</li></ul></li></ul><h3 id="data_received">data_received</h3><ul><li>reg [1]</li><li><a href="#s_axis_tready">S_AXIS_TREADY</a>와 <a href="#s_axis_tvalid">S_AXIS_TVALID</a>가 1이면, 즉, 이번 cycle에 AXI를 통해서 data를 받았으면 1임</li></ul><h3 id="conv_done">conv_done</h3><ul><li>output [1]</li><li>항상 0이고 ~일 때만 1임<ul><li><a href="#data_received">data_received</a>가 0이고 partial_receive_done이 1이고 SEND_ONE_IMAGE_DONE이 1이고 <code class="inline-code-span">resume_receive_weight_cnt &gt;= output_len / 4 - 1</code>일 때</li></ul></li></ul>
        <a id="bottom"></a>
    </article>





    <script src="colors.js"></script>

    
    <script src="nav.js"></script>
    
</body>

</html>